{
    "beforeSaveApiScript": "$maxBookedTickets = 3;\n\nif (entity\\isNew()) {\n    //check if ticket already exist\n    if (record\\exists('Ticket', \n            'row=', row, \n            'seat=', seat, \n            'status!=', 'notPaid',\n            'eventId=', eventId)) {\n        recordService\\throwDuplicateConflict('Це місце вже зайняли');\n    }\n    \n    \n    //check number of tickets for this contact\n    $ticketsCount = record\\count('Ticket', 'phone=', phone, 'status=', \"booked\", 'eventId=', eventId);\n    if ($ticketsCount >= $maxBookedTickets) {\n        recordService\\throwForbidden(string\\concatenate('Бронювати можна не більше ', $maxBookedTickets, ' квитків'));\n    }\n    \n    //get event map\n    $map = record\\attribute('Event', eventId, 'map');\n    if (!$map) {\n        recordService\\throwBadRequest('Мапа не налаштована');\n    }\n    \n    //remove skipers and spaces\n    $map = string\\replace($map, ' ', '');  //remove spaces\n    $map = string\\replace($map, '_\\n', '');//remove row skiper\n    $map = string\\replace($map, '_', '');  //remove seat skiper\n    \n    //get template from map\n    $mapAsArr = string\\split($map, '\\n');\n    $mapRow = array\\at($mapAsArr, row - 1);\n    $mapSeat = string\\substring($mapRow, seat - 1, 1);\n    \n    if (!$mapSeat) {\n        recordService\\throwBadRequest('Місце не знайдено');\n    }\n    \n    //get ticketType\n    $ticketTypeId = record\\findOne('TicketType', 'createdAt', 'desc', 'eventId=', eventId, 'nameOnMap=', $mapSeat);\n    if (!$ticketTypeId) {\n        recordService\\throwBadRequest('Шаблон не знайдено');\n    }\n    \n    //set full place name\n    $indexer = record\\attribute('Event', eventId, 'indexer');\n    $i = 0;\n    while($i < array\\length($indexer),\n        (\n            $indexerVal = array\\at($indexer,$i);\n            if (string\\contains($indexerVal, string\\concatenate(row,  ' ', seat, '-'))) {\n                $placeNameArr = array\\at(string\\split($indexerVal, '-'), 1);\n                $placeName = array\\at(string\\split($placeNameArr, ','), 0);\n                $placeNumber = array\\at(string\\split($placeNameArr, ','), 1);\n                place = string\\concatenate($placeName, ', Місце', $placeNumber);\n            }\n            $i = $i + 1;\n        )\n    );\n    \n    if (!place) {\n        place = string\\concatenate('Ряд: ', row, ' Місце: ', seat);\n    }\n    \n    $phone = string\\concatenate('+', phone);\n    $clientId = record\\findOne('Contact', 'createdAt', 'desc', 'phoneNumber=', $phone, 'phoneNumber!=', null);\n    if (!$clientId) {\n        $clientId = record\\create('Contact',\n            'firstName', name,\n            'lastName', 'квиток',\n            'emailAddress', email,\n            'phoneNumber', $phone,\n            'assignedUserId', env\\userAttribute('id')\n        );\n    }\n    \n    //ticket fields\n    //eventId = $eventId;\n    bookedStart = datetime\\now();\n    bookedEnd = datetime\\addHours(bookedStart, record\\attribute('Event', eventId, 'bookingTime'));\n    contactId = $clientId;\n    ticketTypeId = $ticketTypeId;\n    price = record\\attribute('TicketType', $ticketTypeId, 'price');\n    assignedUserId = env\\userAttribute('id');\n    teamsIds = env\\userAttribute('teamsIds');\n}"
}