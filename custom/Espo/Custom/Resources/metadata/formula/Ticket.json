{
    "beforeSaveApiScript": "/*\n$maxBookedTickets = 3;\n$emailTemplateId = '663767067ebd336ed';\n\n//before insert\nif (entity\\isNew()) {\n    //check if ticket already exist\n    if (record\\exists('Ticket', \n            'row=', row, \n            'seat=', seat, \n            'status!=', 'notPaid',\n            'eventId=', eventId)) {\n        recordService\\throwDuplicateConflict('Це місце вже зайняли');\n    }\n    \n    \n    //check number of tickets for this contact\n    $ticketsCount = record\\count('Ticket', 'phone=', phone, 'status=', \"booked\", 'eventId=', eventId);\n    if ($ticketsCount >= $maxBookedTickets) {\n        recordService\\throwForbidden(string\\concatenate('Бронювати можна не більше ', $maxBookedTickets, ' квитків'));\n    }\n    \n    //get event map\n    $map = record\\attribute('Event', eventId, 'map');\n    if (!$map) {\n        recordService\\throwBadRequest('Мапа не налаштована');\n    }\n    \n    //remove skipers and spaces\n    $map = string\\replace($map, ' ', '');  //remove spaces\n    $map = string\\replace($map, '=\\n', '');//remove row skiper\n    $map = string\\replace($map, '_', '');  //remove seat skiper\n    \n    //get template from map\n    $mapAsArr = string\\split($map, '\\n');\n    $mapRow = array\\at($mapAsArr, row - 1);\n    $mapSeat = string\\substring($mapRow, seat - 1, 1);\n    \n    if (!$mapSeat) {\n        recordService\\throwBadRequest('Місце не знайдено');\n    }\n    \n    //get ticketType\n    $ticketTypeId = record\\findOne('TicketType', 'createdAt', 'desc', 'eventId=', eventId, 'nameOnMap=', $mapSeat);\n    if (!$ticketTypeId) {\n        recordService\\throwBadRequest('Шаблон не знайдено');\n    }\n    \n    //set full place name\n    $indexer = record\\attribute('Event', eventId, 'indexer');\n    $i = 0;\n    $index = string\\concatenate(row,  ' ', seat);\n    while($i < array\\length($indexer),\n        (\n            $indexerVal = array\\at($indexer, $i);\n            $indexPart = array\\at(string\\split($indexerVal, '-'), 0);\n            \n            if ($index == $indexPart) {\n                $placeNameArr = array\\at(string\\split($indexerVal, '-'), 1);\n                $placeName = array\\at(string\\split($placeNameArr, ','), 0);\n                $placeNumber = array\\at(string\\split($placeNameArr, ','), 1);\n                \n                place = string\\concatenate($placeName, ', Місце', $placeNumber);\n            }\n            $i = $i + 1;\n        )\n    );\n    \n    if (!place) {\n        place = string\\concatenate('Ряд: ', row, ' Місце: ', seat);\n    }\n    \n    $phone = string\\concatenate('+', phone);\n    $clientId = record\\findOne('Contact', 'createdAt', 'desc', 'phoneNumber=', $phone);\n    if (!$clientId) {\n        $clientId = record\\create('Contact',\n            'firstName', name,\n            'lastName', 'квиток',\n            'emailAddress', email,\n            'phoneNumber', $phone,\n            'assignedUserId', env\\userAttribute('id'),\n            'teamsIds' = env\\userAttribute('teamsIds')\n        );\n    }\n    \n    //ticket fields\n    //eventId = $eventId;\n    name = place;\n    bookedStart = datetime\\now();\n    bookedEnd = datetime\\addHours(bookedStart, record\\attribute('Event', eventId, 'bookingTime'));\n    contactId = $clientId;\n    ticketTypeId = $ticketTypeId;\n    price = record\\attribute('TicketType', $ticketTypeId, 'price');\n    assignedUserId = env\\userAttribute('id');\n    teamsIds = env\\userAttribute('teamsIds');\n    \n    //send upload link\n    if (!uploadLinkWasSend) {\n        $emailId = record\\create(\n            'Email',\n            'to', email,\n            'status', 'Draft',\n            'parentId', $clientId,\n            'parentType', 'Contact'\n        );\n        ext\\email\\applyTemplate($emailId, $emailTemplateId);\n        ext\\email\\send($emailId);\n        \n        uploadLinkWasSend = true;\n        \n        //prevent other sending\n        $relatedTickets = record\\findMany('Ticket', 10, 'createdAt', 'desc', 'phone=', phone, 'status=', 'booked', 'id!=', id);\n        $i = 0;\n        while($i < array\\length($relatedTickets),\n            (\n                $relatedTicketId = array\\at($relatedTickets, $i);\n                record\\update('Ticket', $relatedTicketId, 'uploadLinkWasSend', true);\n                $i = $i + 1;\n            )\n        );\n    }\n}\n\n//before update\nif (!entity\\isNew()) {\n    if (entity\\isAttributeChanged('screenshotId')) {\n        $relatedTickets = record\\findMany('Ticket', 10, 'createdAt', 'desc', 'phone=', phone, 'status=', 'booked', 'id!=', id);\n        $i = 0;\n        while($i < array\\length($relatedTickets),\n            (\n                $relatedTicketId = array\\at($relatedTickets, $i);\n                record\\update('Ticket', $relatedTicketId, 'screenshotId', screenshotId);\n                $i = $i + 1;\n            )\n        );\n    }\n}\n*/",
    "beforeSaveCustomScript": "/*\n$emailTemplateId = '661e4abcb188bee49';\n\n//send email button triggers this part\nif (!entity\\isNew() && entity\\isAttributeChanged('sendEmailTrigger')) {\n    $emailId = record\\create(\n        'Email',\n        'to', email,\n        'status', 'Draft',\n        'parentId', entity\\attribute('id'),\n        'parentType', 'Ticket'\n    );\n    ext\\email\\applyTemplate($emailId, $emailTemplateId);\n    ext\\email\\send($emailId);\n    \n    emailWasSend = true;\n}\n\n//on update\nif (!entity\\isNew()) {\n    if (entity\\isAttributeChanged('status') && status == 'paid') {\n        salesDate = datetime\\today();\n        isPaid = true;\n        if (screenshotId != null) {\n            paymentMethod = 'iban';\n        }\n    }\n}\n*/"
}